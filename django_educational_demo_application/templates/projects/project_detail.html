{% extends "base.html" %}

{% load i18n %}

{% block title %}
  {{ project.title }} - {% translate "Project Details" %}
{% endblock title %}
{% block content %}
  <div class="container mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <a href="{% url 'projects:dashboard' %}">{% translate "Dashboard" %}</a>
        </li>
        <li class="breadcrumb-item">
          <a href="{% url 'projects:project_list' %}">{% translate "Projects" %}</a>
        </li>
        <li class="breadcrumb-item active">{{ project.title }}</li>
      </ol>
    </nav>
    <!-- Project Header -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h1 class="h3 mb-0">{{ project.title }}</h1>
        <div>
          <a href="{% url 'projects:project_update' project.pk %}"
             class="btn btn-sm btn-outline-primary">{% translate "Edit" %}</a>
          <a href="{% url 'projects:project_delete' project.pk %}"
             class="btn btn-sm btn-outline-danger">{% translate "Delete" %}</a>
        </div>
      </div>
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <p class="mb-1">
              <strong>{% translate "Student" %}:</strong> <a href="{{ project.student.get_absolute_url }}">{{ project.student.user.username }}</a>
            </p>
            <p class="mb-1">
              <strong>{% translate "Course" %}:</strong> <a href="{{ project.course.get_absolute_url }}">{{ project.course.code }}</a>
            </p>
          </div>
          <div class="col-md-6">
            <p class="mb-1">
              <strong>{% translate "Status" %}:</strong>
              <span class="badge bg-{% if project.status == 'completed' %}success{% elif project.status == 'in_progress' %}warning{% elif project.status == 'draft' %}secondary{% else %}info{% endif %}">
                {{ project.get_status_display }}
              </span>
            </p>
            <p class="mb-1">
              <strong>{% translate "Priority" %}:</strong>
              <span class="badge bg-{% if project.priority == 'high' %}danger{% elif project.priority == 'medium' %}warning{% else %}success{% endif %}">
                {{ project.get_priority_display }}
              </span>
            </p>
          </div>
        </div>
        {% if project.deadline %}
          <div class="alert {% if project.is_overdue %}alert-danger{% else %}alert-info{% endif %} mb-3">
            <strong>{% translate "Deadline" %}:</strong> {{ project.deadline|date:"M d, Y" }}
            {% if project.is_overdue %}
              <span class="badge bg-danger">{% translate "Overdue by" %} {{ project.days_until_deadline|abs }} {% translate "days" %}</span>
            {% elif project.days_until_deadline %}
              <span class="badge bg-info">{% translate "days remaining" %}: {{ project.days_until_deadline }}</span>
            {% endif %}
          </div>
        {% endif %}
        <p class="card-text">{{ project.description }}</p>
        {% if project.repository_url %}
          <p>
            <strong>{% translate "Repository" %}:</strong>
            <a href="{{ project.repository_url }}" target="_blank" rel="noopener">{{ project.repository_url }}</a>
          </p>
        {% endif %}
        {% if project.deployed_url %}
          <p>
            <strong>{% translate "Deployed" %}:</strong>
            <a href="{{ project.deployed_url }}" target="_blank" rel="noopener">{{ project.deployed_url }}</a>
          </p>
        {% endif %}
        {% if project.score %}
          <div class="mt-3">
            <strong>{% translate "Score" %}:</strong>
            <span class="badge bg-success fs-6">{{ project.score }}/100</span>
          </div>
        {% endif %}
        {% if project.completed_at %}
          <div class="mt-2">
            <small class="text-muted">{% translate "Completed" %}: {{ project.completed_at|date:"M d, Y H:i" }}</small>
          </div>
        {% endif %}
      </div>
    </div>
    <!-- Progress -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">{% translate "Progress" %}</h5>
      </div>
      <div class="card-body">
        <div class="progress mb-3 progress-medium">
          <div class="progress-bar"
               role="progressbar"
               style="width: {{ project.progress_percentage }}%"
               aria-valuenow="{{ project.progress_percentage }}"
               aria-valuemin="0"
               aria-valuemax="100">{{ project.progress_percentage }}%</div>
        </div>
        <p class="mb-0">
          {{ project.get_completed_task_count }} {% translate "of" %} {{ project.get_task_count }} {% translate "tasks completed" %}
        </p>
      </div>
    </div>
    <div class="row">
      <!-- Tasks -->
      <div class="col-md-8">
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">{% translate "Tasks" %}</h5>
            <button type="button"
                    class="btn btn-sm btn-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#taskModal">
              <i class="bi bi-plus-circle"></i> {% translate "Add Task" %}
            </button>
          </div>
          <div class="card-body">
            {% if tasks %}
              <ul class="list-group list-group-flush">
                {% for task in tasks %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div class="form-check">
                      <input class="form-check-input task-checkbox"
                             type="checkbox"
                             data-task-id="{{ task.pk }}"
                             {% if task.is_completed %}checked{% endif %} />
                      <label class="form-check-label {% if task.is_completed %}text-decoration-line-through text-muted{% endif %}">
                        {{ task.title }}
                      </label>
                      {% if task.description %}<small class="text-muted d-block">{{ task.description|truncatewords:10 }}</small>{% endif %}
                    </div>
                    <button class="btn btn-sm btn-outline-danger delete-task"
                            data-task-id="{{ task.pk }}">
                      <i class="bi bi-trash"></i>
                    </button>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted">{% translate "No tasks yet. Add the first task!" %}</p>
            {% endif %}
          </div>
        </div>
        <!-- Status History -->
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">{% translate "Status History" %}</h5>
          </div>
          <div class="card-body">
            {% if status_logs %}
              <ul class="list-group list-group-flush">
                {% for log in status_logs %}
                  <li class="list-group-item">
                    <small class="text-muted">{{ log.changed_at|date:"M d, Y H:i" }}</small>
                    <br />
                    <strong>{{ log.old_status }}</strong> → <strong>{{ log.new_status }}</strong>
                    {% if log.changed_by %}
                      <span class="text-muted">{% translate "by" %} {{ log.changed_by.username }}</span>
                    {% endif %}
                    {% if log.comment %}<p class="mb-0 text-muted small">{{ log.comment }}</p>{% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted">{% translate "No status changes recorded." %}</p>
            {% endif %}
          </div>
        </div>
      </div>
      <!-- Status Transition -->
      <div class="col-md-4">
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">{% translate "Change Status" %}</h5>
          </div>
          <div class="card-body">
            {% if allowed_transitions %}
              <form id="transition-form" data-project-id="{{ project.pk }}">
                {% csrf_token %}
                <div class="mb-3">
                  <label for="new_status" class="form-label">{% translate "New Status" %}</label>
                  <select name="new_status" id="new_status" class="form-select">
                    {% for status, label in allowed_transitions %}<option value="{{ status }}">{{ label }}</option>{% endfor %}
                  </select>
                </div>
                <div class="mb-3">
                  <label for="comment" class="form-label">{% translate "Comment (optional)" %}</label>
                  <textarea name="comment" id="comment" class="form-control" rows="2"></textarea>
                </div>
                <button type="submit" class="btn btn-primary w-100">{% translate "Update Status" %}</button>
              </form>
            {% else %}
              <p class="text-muted">{% translate "No status transitions available." %}</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Add Task Modal -->
  <div class="modal fade" id="taskModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="task-form" data-project-id="{{ project.pk }}">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title">{% translate "Add Task" %}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="task_title" class="form-label">{% translate "Title" %}</label>
              <input type="text"
                     name="title"
                     id="task_title"
                     class="form-control"
                     required />
            </div>
            <div class="mb-3">
              <label for="task_description" class="form-label">{% translate "Description" %}</label>
              <textarea name="description"
                        id="task_description"
                        class="form-control"
                        rows="3"></textarea>
            </div>
            <div class="mb-3">
              <label for="task_order" class="form-label">{% translate "Order" %}</label>
              <input type="number"
                     name="order"
                     id="task_order"
                     class="form-control"
                     min="0" />
            </div>
          </div>
          <div class="modal-footer">
            <button type="button"
                    class="btn btn-outline-secondary"
                    data-bs-dismiss="modal">{% translate "Cancel" %}</button>
            <button type="submit" class="btn btn-primary">{% translate "Add Task" %}</button>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endblock content %}
{% block inline_javascript %}
  <script>
    // Task toggle completion
    document.querySelectorAll('.task-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        const taskId = this.dataset.taskId;
        fetch(`/tasks/${taskId}/update/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
              'X-Requested-With': 'XMLHttpRequest'
            }
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              location.reload();
            }
          });
      });
    });

    // Delete task
    document.querySelectorAll('.delete-task').forEach(button => {
      button.addEventListener('click', function() {
        if (confirm('{% translate "Are you sure you want to delete this task?" %}')) {
          const taskId = this.dataset.taskId;
          fetch(`/tasks/${taskId}/delete/`, {
              method: 'POST',
              headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
              }
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                location.reload();
              }
            });
        }
      });
    });

    // Add task
    document.getElementById('task-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const projectId = this.dataset.projectId;
      fetch(`/projects/${projectId}/tasks/create/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            location.reload();
          }
        });
    });

    // Status transition
    document.getElementById('transition-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const projectId = this.dataset.projectId;
      fetch(`/projects/${projectId}/transition/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            location.reload();
          } else {
            alert('Ошибка: ' + JSON.stringify(data.errors));
          }
        });
    });
  </script>
{% endblock inline_javascript %}
