stages:
  - lint
  - test
  - build
  - publish
  - terraform
  - deploy
  - smoke
  - rollback

variables:
  IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  LATEST_TAG: $CI_REGISTRY_IMAGE:latest

# ---------------- LINT ----------------
linter_check_ruff:
  stage: lint
  image: python:3.13-slim
  script:
    - pip install uv
    - uv venv
    - uv sync --locked
    - uv run pre-commit run --all-files

# ---------------- TEST ----------------
test_with_pytest:
  stage: test
  image: ghcr.io/astral-sh/uv:python3.13-bookworm
  services:
    - postgres:15
  variables:
    POSTGRES_USER: test
    POSTGRES_PASSWORD: test
    POSTGRES_DB: test_db
  script:
    - uv sync --locked
    - uv run pytest

# ---------------- BUILD ----------------
build_image:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - mkdir -p /kaniko/.docker
    - |
      cat > /kaniko/.docker/config.json <<EOF
      {
        "auths": {
          "$CI_REGISTRY": {
            "username": "$CI_REGISTRY_USER",
            "password": "$CI_REGISTRY_PASSWORD"
          }
        }
      }
      EOF
    - >
      /kaniko/executor
      --context "$CI_PROJECT_DIR"
      --dockerfile "$CI_PROJECT_DIR/Dockerfile"
      --destination "$IMAGE_TAG"
      --cache=true

# ---------------- PUBLISH ----------------
publish_latest:
  stage: publish
  image: gcr.io/go-containerregistry/crane:debug
  needs:
    - build_image
  script:
    - crane auth login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - crane tag $IMAGE_TAG latest
  only:
    - main

# ---------------- TERRAFORM APPLY ----------------
terraform_apply:
  stage: terraform
  image: hashicorp/terraform:1.6
  before_script:
    - cd infra
  script:
    - terraform init
    - terraform validate
    - terraform plan -out=tfplan
    - terraform apply -auto-approve tfplan
  artifacts:
    paths:
      - infra/terraform.tfstate
  only:
    - main

# ---------------- ANSIBLE DEPLOY ----------------
ansible_deploy:
  stage: deploy
  image: python:3.12-slim
  needs:
    - terraform_apply
  before_script:
    - pip install ansible
    - cd ansible
  script:
    - ansible-playbook site.yml \
        --extra-vars "image=$IMAGE_TAG \
                      registry_url=$CI_REGISTRY \
                      registry_user=$CI_REGISTRY_USER \
                      registry_password=$CI_REGISTRY_PASSWORD"
  only:
    - main

# ---------------- SMOKE TEST ----------------
smoke_test:
  stage: smoke
  image: curlimages/curl:latest
  needs:
    - ansible_deploy
  script:
    - echo "Running smoke test..."
    - curl -f http://$APP_PUBLIC_IP/health
  only:
    - main

# ---------------- ROLLBACK ----------------
rollback:
  stage: rollback
  image: python:3.12-slim
  when: on_failure
  needs:
    - smoke_test
  before_script:
    - pip install ansible
    - cd ansible
  script:
    - echo "Rollback to previous image"
    - ansible-playbook site.yml \
        --extra-vars "image=$PREVIOUS_IMAGE \
                      registry_url=$CI_REGISTRY \
                      registry_user=$CI_REGISTRY_USER \
                      registry_password=$CI_REGISTRY_PASSWORD"
  only:
    - main
